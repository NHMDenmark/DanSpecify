## Upgrading Specify7 to 7.7.4 server process ##

# NOTE: Follow instructions on https://github.com/specify/specify7/#installation but take heed of the following: 

# 1. First preparations

su specify

# IF NECESSARY, download the latest version of Specify6 into a /opt/tmp folder 
sudo wget https://update.specifysoftware.org/Specify_unix_64.sh
#  then install it into the /opt/Specify6/Specify6.8.01 folder 
sudo sh Specify_unix_64.sh -q -dir /opt/Specify6/Specify6.8.01
#  Switch symlink to this version of Specify6 
sudo unlink /opt/specify6
sudo ln -sf /opt/Specify6/Specify6.8.01 /opt/specify6
sudo ln -sf /opt/specify6 /opt/specify

#  Setup specify7.7.4
cd ~/versions/
mkdir v7.7.4
cd v7.7.4
git clone https://github.com/specify/specify7.git
cp ~/versions/v7.6.1/specify7/specifyweb/settings/local_specify_settings.py ~/versions/v7.7.4/specify7/specifyweb/settings/local_specify_settings.py

# In case yum refuses to install certain required libraries like e.g. redis lines need to be added to the redhat repo file;
sudo nano /etc/yum.repos.d/redhat.repo		#add the following lines: 

[epel]
name=Extra Packages for Enterprise Linux 7 - $basearch
#baseurl=http://download.fedoraproject.org/pub/epel/7/$basearch
metalink=https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=$basearch
failovermethod=priority
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7

# *** If not already created beforehand, an automated service for Celery & Redis worker process will be needed for WorkBench amongst others ***
#   1. add bash script 

cd ~
nano sp7worker.sh		# add file contents from version in repo
chmod a+x sp7worker.sh

#   2. Create & start service for auto-running script
cd /etc/systemd/system/
sudo nano sp7worker.service		# add file contents from version in repo
sudo systemctl start sp7worker
sudo systemctl enable sp7worker

# Fix nodejs version (only latest stable version v16.15.1) and compile
python3 -m venv specify7/ve 
source specify7/ve/bin/activate

cd specify7

curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
source ~/.nvm/nvm.sh
nvm install --lts

npm install -g npm@8.12.1

pip install --upgrade pip
pip install --upgrade pip # yes, do it multiple times if necessary

# make sure that all other requirements are installed 
pip3 install -r requirements.txt

# It may also be necessary to make sure nodejs has enough available memory 
export NODE_OPTIONS=--max_old_space_size=4096

make

# **** The last steps have to be coordinated with the end users!**** 

# 3. Upgrade the database 
#  RIGHT before the migration upgrade the database by connecting to it 
#    with the Specify6.8.01 client and then run the upgrade wizard!
#  HOWEVER make a backup of the old database first using the Specify6 Backup and Restore tool ! 

#  When done, upgrade the database from Specify7 by migrating the django models like so:
python manage.py migrate

deactivate

# 4. Finishing up

unlink ~/currentversion
ln -sf /home/specify/versions/v7.7.4 /home/specify/currentversion

sudo apachectl restart 

sudo tail -f /var/log/httpd/error.log
